# 网络技术

ARPANET 建成标志着计算机网络的出现，ARPANET 是美国国防部筹建。ARPANET 采用分组交换技术，可以连接不同型号的计算机。为了解决不同网络类型中的分组结构、通信机制及传输速率等不一致的问题，出现了 TCP/IP 模型。其中 TCP（Transport Control Protocol）负责分布式进程通信，IP 负责分组转发路由。TCP/IP 属于P2P（点对点）式网络。

网络按覆盖范围分类：

* LAN（Local Area Network，局域网）：最常用的是共享信道，即所有设备都连接在同一条传输线路上。新型LAN主要采用星型拓扑，并遵循 IEEE 802.3 协议标准的以太网（Ethernet），而 WLAN（无线局域网）逐步取代 LAN。
* MAN（Metropolitan Area Network，城域网）：技术跟 LAN 差不多，只包含一两根电缆，以总线形式存在，没有交换设备，遵循 IEEE 802.6 协议，目前很多也采用 Ethernet 技术，跟 LAN 差别不明显。
* WAN（Wide Area Network，广域网）：采用交换技术，通过交换结点（即通信子网）连接分布在各地的主机或局域网连接。数据交换是 WAN 核心，目前主要使用**帧中继**和**ATM**等。而担任通信子网的设备通常是路由器或交换机。
* Inter Networking（互联网）：将世界各地局域网和广域网连接起来的方式。不同厂家生产的网络设备协议标准不同，必须要通过**网关（Gateway）**设备连接起来，完成数据转换功能。

拓扑结构形式：

* 总线拓扑：所有终端连接在一根线路上，同一时刻只能有两个结点通信。一个地方故障，整个网络瘫痪。
* 环形拓扑：封闭的环形线路，优点是通信最大延迟固定。一个地方故障，整个网络瘫痪。
* 星型拓扑：一台数据设备作为中心处理系统，其他结点不能直接通信，必须通过中心处理机转发。缺点是成本高。
* 树形拓扑：星型结构的特例，经过多级处理主机分层相连，每层一个中心处理机。比星型结构省线路成本。
* 网状拓扑：终端可以任意互联，结点可以直接通信，也可经过其他结点转接。缺点是结构复杂，不易管理。

网络逻辑功能：

* 通信子网：负责完成网络数据的传输、转发、交换和路由等任务，由通信处理机、通信线路和其他网络设备构成。
* 资源子网：负责网络数据处理业务，向网络用户提供资源和服务，由主机、终端、联网的外设、软件和信息资源构成。

* Switch（交换机）：负责**网络内部**数据的调度和转发，交换机通过RJ-45或光纤接口与终端相连，并在交换机内部建立地址表，记录终端 MAC 地址和端口关系。OSI数据链路层设备。
* Router（路由器）：连接 IP 网络中不同类型对网络、为不同格式的数据分组选择合适的通信路径并转发的网络中间设备。这种为数据分组选择合适路径的行为就是 Routing（路由），实现路由的方法就是 Routing Algorithm（路由算法）。路由表用于选择转发路径，可以对应固定的静态路由算法，也可以对应动态路由算法。OSI网络层设备。
  * Switch 是实现某种网络内部的数据存储转发，而 Router 是在不同网络之间实现数据的路由和中转。
  * Router 除了 Routing 外，还可以进行网络流量控制、负载均衡、拥塞控制和安全管理。

## 数据通信基础

```txt
[信源] --> [发送设备] --> [信道] --> [接收设备] --> [信宿]
                          |
                       [噪声源]
```

* 信源：将消息转换为电信号的设备，如电话机、摄像机、计算机
* 发送设备：编码和调制信源信号，以适于在信道中传输。
* 信道：传输媒介，分为有线信道、无线信道。如双绞线、同轴电缆、光纤、大气层和外层空间。
* 信宿：将信号转换为人们可以识别的消息。
* Message 消息：是确定的、如文字、气味、图像等。
* Information 信息：抽象等，消息是信息的载体。信息是对事物状态或存在方式对不确定性表述。信息是可以度量的，其大小根据消息的不确定性，即概率成反比。
  * 某件事发生的概率越大，其产生的信息量越小；反之越大。
* Communication 通信：在一点精确或近似地再生另一点的信息。
* Signal 信号：传输信息的载体，通常以电磁或光形式存在，并利用电平、电流和频率等表示信息。信号分为连续信号和离散信号。
* 模拟信号：信号因变量完全随连续消息的变化而变化的信号，自变量可以是连续的，也可以是离散的，但因变量一定是连续的。传统的电视图像信号、电话语音信号、传感器输出信号、遥感遥测信号都是模拟信号。
  * 模拟信号容易受到干扰
* 数字信号：消息因变量是离散的（状态有限），自变量时间的取值也是离散的信号。计算机数据、数字电话、数字电视都是数字信号。
  * 模拟信号可以通过采样、编码转换成数字信号，而数字信号也可以解码、平滑恢复为模拟信号。

### 数据传输方式

计算机作为信源所发出的原始数据信号称为**基本频带信号**（简称**基带信号**），即用固定高低电平来表示二进制。基带信号频率低，信号频谱一般从零频或零频附近开始，功率剧中在有限的频带，具有**低通特性**。不适合长距离或无线传输。直接在信道中传送基带信号，称为**基带传输**，Ethernet、令牌环网等局域网均采用基带传输。

无线信道不具有低通特性，而具有**带通特性**。需要利用基带信号调制与信道匹配的**载波信号**传输，即**频带传输**。

数字基带信号调制方法：

* AM（调幅）：载波的振幅随数字基带信号变化，如 0 无载波，1 有载波。
* FM（调频）：载波的频率随数字基带信号变化，如 0 和 1 对应不同的载波频率 f0 和 f1。
* PM（调相）：载波的初始相位随数字基带信号变化，如 0 表示 0 度，1 表示 180 度。
* QAM（正交幅值调制）、OFDM（正交频分复用）等调制技术可以获得更高等信息传输速率。

* 单工：任何时间只能一个方向通信，如无线电广播；
* 半双工：接收和发送交替，不能双方同时接收或发送。如无线对讲机、HTTP 1.1协议。
* 全双工：如 HTTP 2.0协议、电话网、计算机网络等。
* 并行通信：每次 1 byte（8 bit）数据同时传输，共8条通道。造价贵，不适合长距离传输。如计算机与存储通信等总线传输。
* 串行通信：只有一条通道，数据每bit依次在这条通道传输。价格便宜，适合长距离传输。如计算机外设、RS-232 接口、USB 接口就是串口。

### 数据通信系统性能

* 模拟信号：
  * 有效性：带宽（包括信道带宽和信号传输带宽）
  * 可靠性：信噪比（接收端有用信号的功率和噪声功率的比），越高表示越可靠
* 数字信号：
  * 有效性：传输速率（包括波特率和比特率）和频带利用率
    * 波特率（即码元速率） $R_B = frac{{1}{T}}$ 时间间隔相同的符号表示一个离散值，这个时间间隔内的信号称为**码元**，时间间隔长度称为**码元长度**。波特率表示每秒传输码元数，单位是Baud（波特）。$T(s)$ 表示码元长度。
    * 比特率（即信息速率） $R_b = {R_B}{log_2}M$ 每秒传输二进制比特数，单位 `bit/s`。每个码元含有若干比特，一个二进制码元只包含1 bit信息量，一个M进制码元携带 ${log_2}M$ 比特信息量。如某八进制信号，波特率为1200Baud，那么信息速率为3600bit。

### 差错控制技术

ARQ 自动请求重传：

* **停止等待ARQ** 收到ACK才传下一个包，收到NAK重传这个包
* **GBN ARQ，回退N步ARQ** 把包编号，一次批量传多个，一批次收到一个NAK，就整个批次重传
* **选择性重传ARQ** 把包编号，

香农信道编码定理：对于一个给定的有干扰信道，只要发送端低于信道容量C的数据传输速率R发送信息，则一定存在一种编码使编码错误率P随码长n的增加呈指数下降至任意小值。也就是说，通过编码可以使通信无错误或错误率很低。香农信道编码定理是数据通信差错控制的理论基础。

### 数据交换

数据交换：
  
* circuit switching 电路交换：可以是单工也可以是全双工，主要适用于语音、视频实施性强的业务
* store-forwad 存储转发
  * Message Switching 报文交换：很少使用了
  * Packet Switching 分组交换：数据分组拆包
    * Datagram 数据报：属于无连接业务。**TCP/IP中IP就是数据报网络，网络中出现丢包或差错，网络层不处理，完全由传输层协议处理。**
    * Virtual Circuit 虚电路：面向连接。如X.25、帧中继、ATM异步传输模式等。

> 面向连接的服务又称虚电路（Virtual Circuit）服务；无连接服务又称数据报（Datagram）服务，要求每个分组都要带源地址、目的地地址，独立选择路径，到达顺序不定，到达后需要重新对Packet排序。
> OSI网络层支持面向连接和面向无连接通信，传输层仅支持面向连接通信；
> TCP/IP网络层仅支持面向无连接通信，传输层支持面向连接和面向无连接通信。

TCP/IP 传输层进程间通信必须使用端口（Protocol Port Number）。网络层IP地址标识主机，端口号标识进程。端口号：0~2^10-1是熟知端口，2^10-49151是登记端口，必须在IANA登记使用；49151-65535是客户端口，可临时使用。

UDP是面向报文的，头只有8字节，发送数据不拆分，主要用于交付，不保证可靠交付，适用于视频会议、点播和网络电话。

```txt
0-------------16---------------32
|   src Port   |  dst Port     |
+--------------+---------------+
|    length    |  check sum    |
+--------------+---------------+
|                              |
|             data             |

UDP 数据报结构，头8字节
```

IP不提供可靠通信，就需要TCP控制传输。应用层向TCP发送字节为单位的数据流，TCP将数据流拆分成报文段 Segment（受数据链路层最大传输单元MTU限制）。之后TCP将报文段传给IP，通过网络传送给接收端TCP。TCP会被报文段编序，接收端要在RTT（往返时延）内返回ACK。TCP在发送和接收时都要检验数据释放有错误。

```txt
0----4----8-----------16----------------32
|    src Port         |      dst Port   |
+----4----8-----------16----------------+
|                    seq                |
+----4----8-----------16----------------+
|                  ack_seq              |
+----4----8-----------16----------------+
|len |    |U|A|P|R|S|F|     Window      |
+---------------------16----------------+
|      check sum      |      紧急指针    |
+---------------------16----------------+
|          Option               | Fill  |
+---------------------------------------+

TCP数据报首部结构，头20字节
```

* UAPRSF
  * Urg=1 紧急指针字段有效，要求尽快传送
  * Ack=1 确认序号有效
  * Psh=1 接收端尽快交付接收，不再等到缓存填满再向上交付
  * Rst=1 TCP连接出现差错（主机崩溃），必须释放连接，再重新建立连接
  * Syn=1 建立新连接请求或者同意建立新连接的确认段。
  * Fin=1 表明发送端数据发送完毕，请求释放TCP连接
* Window 用于通知对付接收窗口大小（字节），用于TCP流量控制
* 紧急指针：指出本报文段紧急数据共有多少字节
* 选项字段
  * MSS 最大段长度选项：用于告诉对方我的缓存能接收数据段的最大长度是MSS个字节。MSS只包括应用层字节数，不包括段首部。
  * SACK 选择确认选项：TCP默认采用累计确认机制（seq++），默认SACK选型是开启的

TCP 三次握手，前两次握手SYNC=1的时候会分别耗掉双方一个seq，第三次握手可以传输数据。

  ```txt
  Client                                                       Server
          --------------- [SYN=1,seq=x] --------------------->               第一次握手（不能携带数据）
          <-------------- [SYN=1,ACK=1,ack_seq=x+1,seq=y] ----               第二次握手（不能携带数据）
          --------------- [SYN=0,ACK=1,seq=x+1,ack_seq=y+1] ->               第三次握手（可以携带数据）
  ```

TCP 四次挥手

```txt
Client                                                         Server
        ------- [FIN=1,seq=u] ------------------------------->
        <------ [ACK=1,ack_seq=u+1,seq=v] --------------------
  client 收到第二次挥手，进入等待状态
        <------ [FIN=1,ack_seq=u+1,seq=w] --------------------
        ------- [ACK=1,seq=u+1,ack_seq=w+1] ----------------->               server 收到后可以立即释放连接
  client 发送完最后一次挥手，延迟一段时间后释放连接
```

TCP 可靠的原因：

* 数据被分割成Segment，传给IP
* TCP发送一个Segment后，会启动定时器等待ack_seq，超时就重传
* 首部有检验字段，检验有问题就丢弃，发送端超时会重传
* TCP segment传给面向无连接的IP协议，可能会经过不同的路径，造成顺序错乱。TCP会对数据重新排序。
* 因网络延迟、重传机制导致重复收到segment，会丢弃
* TCP实现流量控制（Flow Control），防止较快主机致使较慢主机缓冲区溢出

TCP Congestion Control 拥塞控制 采用窗口机制，发送端维持一个 cwnd (congestion window)的动态变量，单位字节，用于表示未收到ACK的情况下可以连续发送的数据字节数。发送端根据网络拥塞程度动态调节cwnd大小。

发送端判断拥塞的依据：发送端设置一个RTO（重传计时器），如果RTO到期后，还没有收到ACK，则认为拥塞。

拥塞控制算法：

* 慢启动（slow start）：试探方案，慢慢调大 cwnd。初始 `cwnd = mss`，每收到一个ACK，`cwnd += mss`，这个过程叫**加性增加（Additive Increase）算法**。
  * 为了防止增长过快，需要慢启动阈值`ssthresh = 16`，当`cwnd > ssthresh` 就减缓增速
* 拥塞避免（Congestion Avoidance）：在规定时间没有收到ACK，认为网络拥塞，此时调整ssthresh为超时时cwnd值的一半，同时设`cwnd = 1`。这个过程叫**乘性减少（Multiplicative Decrease）算法**。
* 快速重传（Fast Retranmit）：接收端每收到一个失序segment，就立即re-ack。如收到1、2号，并进行ACK后，又收到4号，那么此时需要重新ACK 2号segment。如果继续收到5、6号，接收端仍然需要重复向发送端重新确认2号segment。此时发送端会收到多个2号ack，那么就认为3号报文段丢包，立即重传3号，不需要等到RTO结束再重传。
* 快速恢复（Fast Recovery）：当发送端收到3个重复确认，就设`ssthresh /= 2; cwnd = ssthresh`。

> TCP中的加性增加和乘性减少算法合称为**AIMD算法**。