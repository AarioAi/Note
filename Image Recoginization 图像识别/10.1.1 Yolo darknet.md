## Compilation  编译

```c
// example/detection.c
// :138
    // 这里是保存weights方式，超过1000步，就10000步保存一次；少于1000步就100步保存一次
    if(i%10000==0 || (i < 1000 && i%100 == 0)){
#ifdef GPU
        if(ngpus != 1) sync_nets(nets, ngpus, 0);
#endif
        char buff[256];
        sprintf(buff, "%s/%s_%d.weights", backup_directory, base, i);
        save_weights(net, buff);
    }
```

也可以改变为 `if(i%1000==0 || (i < 1000 && i%100 == 0)){`  每1000步保存一次

###   Compilation  编译

```shell
sh$ vi Makefile
|[
GPU=1     # with CUDA to accelerate by using GPU (CUDA should be in /usr/local/cuda)
CUDNN=1   # with cuDNN v5-v7 to accelerate training by using GPU (should be in /usr/local/cudnn)
OPENCV=0  # to detect on video
OPENMP=1  # to support using multi-core CPU
DEBUG=0
]|
sh$ make clean
sh$ make
```

* Coords: x, y, width, height

## cfg

### .cfg


 
* [net]
  * **width/height=480**    # width/height must be divisible by 32, increase it will increase precision
* [convolutional]
  * filters=75   # filters = (next [yolo].classes+coords+1)*numberOfMask = (20+5)\*3
  * [yolo]
  * classes=20   # your number of objects
  * **random=1**     # increase precision by training Yolo for differenct resolutions
* [convolutional]
  * filters=45
* [yolo]
  * classes=10

### .data

```ini
classes= 4
train  = 3d_data/train.txt           ; 这里包含训练图片集，并包含一个.txt 标注数据； 如 /tmp/a.jpg  ==> 表示同时包含 /tmp/a.jpg 和 annotation/tmp/a.txt
valid  = 3d_data/test.txt
names = data/3d_4sku.names
backup = backup/3d_4sku_2_6000
```

## Commands

```shell
# Train the model
sh$ ./darknet detector train cfg/coco.data cfg/yolov3.cfg darknet53.conv.74
sh$ ./darknet detector train cfg/coco.data cfg/yolov3.cfg darknet53.conv.74 -gpus 0,1,2,3

# Stop and restart training from a checkpoint
sh$ ./darknet detector train cfg/coco.data cfg/yolov3.cfg backup/yolov3.backup

# Test
# @notice set batch=1 and subdivisions=1 when do test
#   `detect` is shorthand for `detector test cfg/coco.data`
# @param -thresh default to 0.25, displays objects detected with a confidence of .25+
sh$ ./darknet detect cfg/yolov3.cfg trained.weights data/dog.jpg -thresh 0.25

sh$ ./darknet detector test cfg/coco.data cfg/yolov3.cfg trained.weights data/dog.jpg -thresh 0.25
sh$ ./darknet detector test cfg/coco.data cfg/yolov3.cfg trained.weights -thresh 0.25
sh$ ./darknet detector test cfg/coco.data cfg/yolov3.cfg trained.weights -thresh 0.25
```

### When should I stop training

1. No longer decreases 0.xxxx avg        --->  average loss error, the lower, the better
2. Get weights from **Early Stopping Point**

* **IoU** (Intersect of Union)
* **mAP** (Mean Average Precision)

### How to improve object detection
1. Before training
  * set flag `random=1` and increase `width` and `height` in `.cfg`
  * recalculate anchors, and set the anchors to `yolo.anchors` in `.cfg`
    * `sh$ ./darknet detector calc_anchors data/xx.data -num_of_clusters 9 -width 416 -height 416`
  * 